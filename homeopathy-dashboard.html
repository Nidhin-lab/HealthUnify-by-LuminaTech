<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Homeopathy Dashboard | HealthAI</title>
    <!-- Importing Font Awesome for icons -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <!-- Importing Poppins and Inter fonts -->
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;500;600;700;800&family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <!-- Importing Chart.js for data visualization -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    
    <style>
        /* Homeopathy Theme Colors (Subtle Violet and Light Blue) */
        :root {
            --primary-color: #7D3C98; /* Deep Violet - Signature color of gentle healing */
            --secondary-color: #85C1E9; /* Light Blue - Water/Dilution theme */
            --background-dark: #212121;
            --surface-dark: #303030;
            --text-light: #ffffff;
            --glass-bg: rgba(255, 255, 255, 0.08);
            --glass-border: rgba(255, 255, 255, 0.1);
            --shadow-color: rgba(0, 0, 0, 0.4);
            --success-color: #58D68D; /* Subtle Green */
            --alert-color: #E74C3C;
        }

        * {
            box-sizing: border-box;
            font-family: 'Inter', sans-serif;
        }

        body {
            background: linear-gradient(135deg, var(--background-dark), #101010);
            color: var(--text-light);
            margin: 0;
            padding: 0;
            min-height: 100vh;
            display: flex;
            transition: all 0.3s ease-in-out;
        }

        /* Helper Styles */
        .glass-effect {
            background: var(--glass-bg);
            backdrop-filter: blur(10px);
            border: 1px solid var(--glass-border);
            border-radius: 16px;
            box-shadow: 0 4px 30px var(--shadow-color);
        }

        .glass-card {
            background: rgba(0, 0, 0, 0.15);
            border: 1px solid var(--glass-border);
            border-radius: 12px;
            padding: 20px;
            transition: transform 0.2s, box-shadow 0.2s;
        }

        .glass-card:hover {
            transform: translateY(-2px);
            box-shadow: 0 8px 35px var(--shadow-color);
        }

        .health-gradient {
            background: linear-gradient(90deg, var(--primary-color), var(--secondary-color));
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
        }

        /* Sidebar Styling */
        .sidebar {
            width: 250px;
            min-height: 100vh;
            padding: 20px;
            position: fixed;
            left: 0;
            top: 0;
            z-index: 1000;
            display: flex;
            flex-direction: column;
            border-right: none;
        }

        .sidebar.collapsed {
            width: 80px;
        }

        .sidebar-header {
            display: flex;
            align-items: center;
            justify-content: space-between;
            margin-bottom: 30px;
        }

        .logo-text {
            font-size: 1.5rem;
            font-weight: 700;
            white-space: nowrap;
            overflow: hidden;
            transition: opacity 0.3s;
        }
        
        .sidebar.collapsed .logo-text,
        .sidebar.collapsed .sidebar-logo {
            display: none;
        }

        .sidebar-logo {
            width: 40px;
            height: 40px;
            object-fit: contain;
        }
        
        .sidebar-toggle {
            background: none;
            border: none;
            color: var(--text-light);
            font-size: 1.2rem;
            cursor: pointer;
            padding: 8px;
            border-radius: 8px;
            transition: background 0.2s;
        }

        .sidebar-toggle:hover {
            background: rgba(255, 255, 255, 0.1);
        }

        .nav-link {
            display: flex;
            align-items: center;
            padding: 12px 15px;
            margin-bottom: 10px;
            color: var(--text-light);
            text-decoration: none;
            border-radius: 10px;
            transition: background 0.3s, color 0.3s;
            font-weight: 500;
        }

        .nav-link i {
            margin-right: 15px;
            width: 20px;
            text-align: center;
        }

        .sidebar.collapsed .nav-link span {
            display: none;
        }
        
        .sidebar.collapsed .nav-link i {
            margin-right: 0;
        }

        .nav-link.active, .nav-link:hover {
            background: linear-gradient(90deg, var(--primary-color), var(--secondary-color));
            box-shadow: 0 4px 15px rgba(125, 60, 152, 0.4);
            color: var(--text-light);
        }

        /* Main Content Styling */
        .main-content {
            margin-left: 250px;
            padding: 30px;
            flex-grow: 1;
            transition: margin-left 0.3s ease-in-out;
        }

        .sidebar.collapsed + .main-content {
            margin-left: 80px;
        }
        
        .header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 30px;
        }

        .header h1 {
            font-family: 'Poppins', sans-serif;
            font-size: 2.5rem;
            font-weight: 700;
        }
        
        .user-info {
            display: flex;
            align-items: center;
        }

        .user-info img {
            width: 40px;
            height: 40px;
            border-radius: 50%;
            object-fit: cover;
            margin-left: 15px;
            border: 2px solid var(--primary-color);
        }

        .content-section {
            display: none;
            padding-top: 20px;
        }
        
        .content-section.active {
            display: block;
        }
        
        /* Dashboard Grid */
        .dashboard-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 25px;
        }

        /* Chart Card */
        .chart-card {
            min-height: 350px;
        }

        .chart-card canvas {
            max-height: 280px;
        }

        /* Overview Card */
        .overview-card {
            display: flex;
            flex-direction: column;
            justify-content: space-between;
            align-items: flex-start;
        }

        .overview-card .stat-value {
            font-size: 3rem;
            font-weight: 700;
            margin-top: 10px;
            line-height: 1;
            background: var(--primary-color);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            animation: pulse-color 5s infinite alternate;
        }

        @keyframes pulse-color {
            0% { filter: hue-rotate(0deg); }
            100% { filter: hue-rotate(30deg); }
        }

        /* Remedies & Records List */
        .list-container {
            display: grid;
            gap: 20px;
        }

        .remedy-card, .record-card {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 15px 20px;
        }

        .remedy-info, .record-info {
            flex-grow: 1;
        }

        .remedy-name, .record-name {
            font-size: 1.2rem;
            font-weight: 600;
        }

        .remedy-details, .record-details {
            font-size: 0.9rem;
            opacity: 0.7;
            margin-top: 4px;
        }

        .remedy-actions, .record-actions {
            display: flex;
            gap: 10px;
        }

        .btn-icon {
            background: rgba(255, 255, 255, 0.1);
            border: none;
            color: var(--text-light);
            width: 35px;
            height: 35px;
            border-radius: 8px;
            cursor: pointer;
            transition: background 0.2s, transform 0.1s;
        }

        .btn-icon:hover {
            background: var(--primary-color);
        }
        
        .btn-primary {
            background: var(--primary-color);
            color: var(--text-light);
            border: none;
            padding: 10px 20px;
            border-radius: 10px;
            cursor: pointer;
            font-weight: 600;
            transition: background 0.3s;
        }

        .btn-primary:hover {
            background: var(--secondary-color);
        }
        
        /* AI Health Assistant Section */
        #section-ai-assistant {
            display: grid;
            grid-template-columns: 1fr;
            gap: 25px;
        }
        
        .ai-chat-container {
            min-height: 400px;
            display: flex;
            flex-direction: column;
            justify-content: space-between;
        }
        
        .message-container {
            padding: 10px;
            overflow-y: auto;
            max-height: 350px;
        }
        
        .ai-message, .user-message {
            display: flex;
            margin-bottom: 15px;
        }

        .ai-message .message-content,
        .user-message .message-content {
            max-width: 80%;
            padding: 12px 18px;
            border-radius: 18px;
        }
        
        /* AI message specific styles */
        .ai-message {
            justify-content: flex-start;
        }
        .ai-message .message-icon {
            align-self: flex-start;
            margin-right: 10px; /* Space between icon and bubble */
            color: var(--primary-color);
        }
        .ai-message .message-content {
            background: var(--surface-dark);
            border-bottom-left-radius: 2px;
        }
        .ai-message .message-content.loading-pulse {
             font-size: 1.5rem;
             animation: pulse 1s infinite;
        }
        @keyframes pulse {
            0% { opacity: 0.5; }
            50% { opacity: 1; }
            100% { opacity: 0.5; }
        }

        /* User message specific styles */
        .user-message {
            justify-content: flex-end;
        }
        .user-message .message-icon {
             align-self: flex-start;
             margin-left: 10px; /* Space between icon and bubble */
             color: var(--text-light);
        }
        .user-message .message-content {
            background: var(--primary-color);
            border-bottom-right-radius: 2px;
        }


        .message-icon {
            font-size: 1.2rem;
            align-self: flex-start;
        }

        
        .chat-input-area {
            display: flex;
            padding: 15px 20px 0 20px;
            border-top: 1px solid rgba(255, 255, 255, 0.1);
        }

        .chat-input-area input {
            flex-grow: 1;
            padding: 12px;
            border: 1px solid var(--glass-border);
            border-radius: 8px 0 0 8px;
            background: rgba(0, 0, 0, 0.2);
            color: var(--text-light);
            outline: none;
        }

        .chat-input-area button {
            background: var(--primary-color);
            border: none;
            color: var(--text-light);
            padding: 12px 15px;
            border-radius: 0 8px 8px 0;
            cursor: pointer;
            transition: background 0.2s;
        }

        .chat-input-area button:hover {
            background: var(--secondary-color);
        }

        /* AI Analysis Output Styling */
        .ai-analysis-output {
            grid-column: 1 / -1; /* Full width */
            padding: 25px;
            border-left: 5px solid var(--secondary-color);
            animation: fadeIn 0.8s ease-out;
        }
        
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }

        .ai-analysis-output h3 {
            font-size: 1.5rem;
            font-weight: 700;
            color: var(--secondary-color);
            border-bottom: 1px solid var(--glass-border);
            padding-bottom: 10px;
            margin-bottom: 15px;
        }

        .analysis-date {
            font-size: 0.9rem;
            opacity: 0.8;
            margin-bottom: 20px;
        }

        .analysis-segment {
            margin-bottom: 20px;
        }

        .analysis-segment h4 {
            font-weight: 600;
            color: var(--primary-color);
            margin-bottom: 10px;
        }

        .suggestion {
            display: flex;
            align-items: flex-start;
            gap: 10px;
            margin-bottom: 8px;
            padding: 8px;
            border-radius: 6px;
            background: rgba(0, 0, 0, 0.1);
        }
        
        .suggestion.alert {
            color: var(--alert-color);
            background: rgba(231, 76, 60, 0.1);
        }
        
        .remedy-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 10px 0;
            border-bottom: 1px dashed var(--glass-border);
        }

        .remedy-item i {
            margin-right: 10px;
            color: var(--success-color);
        }

        .btn-add-remedy {
            background: var(--success-color);
            color: var(--background-dark);
            border: none;
            padding: 5px 10px;
            border-radius: 6px;
            cursor: pointer;
            font-size: 0.9rem;
            font-weight: 600;
        }

        /* Custom Modal Styling */
        .modal-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.7);
            backdrop-filter: blur(5px);
            display: none;
            justify-content: center;
            align-items: center;
            z-index: 2000;
        }
        .modal-content {
            padding: 30px;
            max-width: 400px;
            text-align: center;
            animation: slideIn 0.3s ease-out;
        }
        @keyframes slideIn {
            from { transform: translateY(-50px); opacity: 0; }
            to { transform: translateY(0); opacity: 1; }
        }
        .loading-spinner {
            border: 4px solid rgba(255, 255, 255, 0.3);
            border-radius: 50%;
            border-top: 4px solid var(--primary-color);
            width: 24px;
            height: 24px;
            animation: spin 1s linear infinite;
            margin: 10px auto;
        }
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        /* Responsiveness */
        @media (max-width: 1024px) {
            .sidebar {
                width: 80px;
                padding: 15px 10px;
            }
            .sidebar:not(.collapsed) {
                width: 200px;
            }
            .sidebar.collapsed {
                width: 250px;
                position: absolute;
                left: -250px;
            }

            .main-content {
                margin-left: 80px;
                padding: 20px;
            }
            
            .header h1 {
                font-size: 2rem;
            }
            
            .dashboard-grid {
                grid-template-columns: 1fr;
            }

            .sidebar-toggle {
                display: block;
            }
        }

        @media (max-width: 600px) {
            .header {
                flex-direction: column;
                align-items: flex-start;
            }
            .user-info {
                margin-top: 15px;
            }
            .sidebar {
                left: -250px;
                transition: left 0.3s ease-in-out;
            }
            .sidebar.open {
                left: 0;
            }
            .main-content {
                margin-left: 0;
            }
            .sidebar.open + .main-content {
                margin-left: 250px;
            }
            .remedy-card, .record-card {
                flex-direction: column;
                align-items: flex-start;
            }
            .remedy-actions, .record-actions {
                margin-top: 10px;
            }
            .chat-input-area {
                padding: 10px;
            }
            .chat-input-area input {
                border-radius: 8px 0 0 8px;
            }
            .chat-input-area button {
                border-radius: 0 8px 8px 0;
            }
        }
    </style>
</head>
<body>
    
    <!-- Sidebar -->
    <aside class="sidebar glass-effect" id="sidebar">
        <div class="sidebar-header">
            <div class="logo-text">
                <span class="health-gradient">Homeo</span><span style="color:#fff;">AI</span>
            </div>
            <button class="sidebar-toggle" id="sidebarToggle">
                <i class="fas fa-bars"></i>
            </button>
        </div>

        <nav class="sidebar-nav">
            <a href="#" class="nav-link active" data-section="section-dashboard">
                <i class="fas fa-th-large"></i> <span>Dashboard</span>
            </a>
            <a href="#" class="nav-link" data-section="section-remedies">
                <i class="fas fa-leaf"></i> <span>Remedies</span>
            </a>
            <a href="#" class="nav-link" data-section="section-records">
                <i class="fas fa-notes-medical"></i> <span>Health Records</span>
            </a>
            <a href="#" class="nav-link" data-section="section-ai-assistant">
                <i class="fas fa-robot"></i> <span>AI Assistant</span>
            </a>
            <a href="#" class="nav-link" data-section="section-settings">
                <i class="fas fa-cog"></i> <span>Settings</span>
            </a>
        </nav>
        
        <div style="margin-top: auto;">
            <!-- START: Added Switch System link -->
            <a href="choose-system.html" class="nav-link">
                <i class="fas fa-repeat"></i> <span>Switch System</span>
            </a>
            <!-- END: Added Switch System link -->
            
            <!-- START: Confirmed Logout link calls logout() and redirects to index.html -->
            <a href="index.html" class="nav-link" onclick="logout()">
                <i class="fas fa-sign-out-alt"></i> <span>Logout</span>
            </a>
            <!-- END: Confirmed Logout link -->
            
            <!-- Placeholder for User ID display -->
            <p id="userIdDisplay" style="font-size:0.75rem; opacity:0.6; padding: 10px; word-break: break-all;">User ID: Loading...</p>
        </div>

        <div class="sidebar-footer">
            <!-- Content moved to above div -->
        </div>
    </aside>

    <!-- Main Content -->
    <div class="main-content" id="mainContent">
        <header class="header">
            <h1 id="pageTitle">Dashboard</h1>
            <div class="user-info">
                <span>Welcome, User!</span>
                <img src="https://placehold.co/40x40/7D3C98/ffffff?text=U" alt="User Avatar">
            </div>
        </header>

        <!-- DASHBOARD SECTION -->
        <section id="section-dashboard" class="content-section active">
            <div class="dashboard-grid">
                
                <!-- Overview Card 1: Vitals Score -->
                <div class="overview-card glass-card">
                    <i class="fas fa-seedling fa-2x" style="color:var(--success-color);"></i>
                    <h3>Current Vitality Score</h3>
                    <div class="stat-value" style="color: var(--success-color);">8.5</div>
                    <p style="opacity:0.8;">(On a scale of 10)</p>
                </div>

                <!-- Overview Card 2: Symptoms Intensity -->
                <div class="overview-card glass-card">
                    <i class="fas fa-sad-tear fa-2x" style="color:var(--alert-color);"></i>
                    <h3>Avg Symptom Intensity</h3>
                    <div class="stat-value" style="color: var(--alert-color);">3/10</div>
                    <p style="opacity:0.8;">(Last 7 days)</p>
                </div>

                <!-- Overview Card 3: Next Consultation -->
                <div class="overview-card glass-card">
                    <i class="fas fa-calendar-check fa-2x" style="color:var(--primary-color);"></i>
                    <h3>Next Consultation</h3>
                    <div class="stat-value" style="color: var(--primary-color); font-size: 2rem;">Dr. Patil</div>
                    <p style="opacity:0.8;">Oct 25, 2025</p>
                </div>
                
                <!-- Chart Card -->
                <div class="chart-card glass-card" style="grid-column: 1 / -1;">
                    <h3>Symptom Trend: Weekly Intensity</h3>
                    <canvas id="symptomChart"></canvas>
                </div>
                
            </div>
        </section>

        <!-- REMEDIES SECTION -->
        <section id="section-remedies" class="content-section">
            <div class="list-header" style="display:flex; justify-content:space-between; margin-bottom: 20px;">
                <h2>Active Remedies</h2>
                <button class="btn-primary"><i class="fas fa-plus"></i> Add Remedy</button>
            </div>
            <div class="list-container">
                <!-- Sample Remedy 1 -->
                <div class="remedy-card glass-card">
                    <div class="remedy-info">
                        <div class="remedy-name">Arnica Montana 30C</div>
                        <div class="remedy-details">Twice Daily • For Muscle Soreness</div>
                    </div>
                    <div class="remedy-actions">
                        <button class="btn-icon" title="Mark Taken"><i class="fas fa-check"></i></button>
                        <button class="btn-icon" title="Edit"><i class="fas fa-edit"></i></button>
                    </div>
                </div>
                <!-- Sample Remedy 2 -->
                <div class="remedy-card glass-card">
                    <div class="remedy-info">
                        <div class="remedy-name">Nux Vomica 6C</div>
                        <div class="remedy-details">As Needed • For Digestive Discomfort</div>
                    </div>
                    <div class="remedy-actions">
                        <button class="btn-icon" title="Mark Taken"><i class="fas fa-check"></i></button>
                        <button class="btn-icon" title="Edit"><i class="fas fa-edit"></i></button>
                    </div>
                </div>
            </div>
        </section>

        <!-- HEALTH RECORDS SECTION -->
        <section id="section-records" class="content-section">
            <div class="list-header" style="display:flex; justify-content:space-between; align-items: center; margin-bottom: 20px;">
                <h2>Uploaded Health Records</h2>
                <!-- File Input for Report Analysis -->
                <input type="file" id="reportFileInput" accept=".txt,.md,application/pdf,image/jpeg,image/png" style="display: none;" onchange="analyzeUploadedReport(this.files[0])">
                <button class="btn-primary" onclick="document.getElementById('reportFileInput').click()">
                    <i class="fas fa-upload"></i> Upload Report (Image/PDF/TXT)
                </button>
            </div>
            <div class="list-container" id="recordsListContainer">
                <!-- Sample Record 1: Static Placeholder -->
                <div id="record-symptom-diary" class="record-card glass-card">
                    <div class="record-info">
                        <div class="record-name">Detailed Symptom Diary</div>
                        <div class="record-details">Personal Note • Oct 1, 2025 • **Sample Data**</div>
                    </div>
                    <div class="record-actions">
                        <button class="btn-icon" title="View"><i class="fas fa-eye"></i></button>
                        <button class="btn-icon" title="Download"><i class="fas fa-download"></i></button>
                        <!-- Button to re-render default analysis -->
                        <button class="btn-icon btn-ai-analyze" title="Show Default Analysis" onclick="showDefaultAnalysis()">
                            <i class="fas fa-brain"></i>
                        </button>
                    </div>
                </div>
                <!-- Sample Record 2 -->
                <div id="record-consultation" class="record-card glass-card">
                    <div class="record-info">
                        <div class="record-name">Consultation Summary</div>
                        <div class="record-details">Dr. Patil • Sep 15, 2025</div>
                    </div>
                    <div class="record-actions">
                        <button class="btn-icon" title="View"><i class="fas fa-eye"></i></button>
                        <button class="btn-icon" title="Download"><i class="fas fa-download"></i></button>
                        <button class="btn-icon btn-ai-analyze" title="Show Default Analysis" onclick="showDefaultAnalysis()">
                            <i class="fas fa-brain"></i>
                        </button>
                    </div>
                </div>
            </div>
        </section>

        <!-- AI HEALTH ASSISTANT SECTION (Analysis Card & Chat) -->
        <section id="section-ai-assistant" class="content-section">
            
            <!-- AI Analysis Results Card (Initial state or last analyzed) -->
            <div id="analysisOutputCard" class="ai-analysis-output glass-card fade-in-up">
                <h3>AI Symptom & Remedy Analysis Summary</h3>
                <p class="analysis-date">Last Analyzed: N/A - Upload a report to begin</p>
                
                <div class="analysis-segment problems-suggested">
                    <h4>Identified Constitutional Pattern:</h4>
                    <div class="suggestion"><i class="fas fa-robot"></i> Upload a detailed symptom report or diary to get an automated constitutional analysis and remedy suggestion.</div>
                </div>

                <div class="analysis-segment remedies-suggested">
                    <h4>AI Remedy & Wellness Recommendations:</h4>
                    <div class="remedy-item" style="border-bottom: none;">
                        <div><i class="fas fa-leaf"></i> Recommendations will appear here after analysis.</div>
                        <div>&nbsp;</div>
                    </div>
                </div>
            </div>

            <!-- AI Chat Interface -->
            <div class="ai-chat-container glass-card">
                <div class="message-container">
                    <!-- AI Welcome Message -->
                    <div class="ai-message">
                        <div class="message-icon"><i class="fas fa-robot"></i></div>
                        <div class="message-content">
                            <p>Hello! I'm your AI Homeopathy Assistant. I specialize in the principles of similia similibus curantur.</p>
                            <ul>
                                <li>Analyze symptoms and suggest potential remedies</li>
                                <li>Check remedy incompatibilities</li>
                                <li>Provide information on potencies and dosing</li>
                            </ul>
                            <p>How can I assist you today?</p>
                        </div>
                    </div>
                </div>
                <div class="chat-input-area">
                    <input type="text" id="chatInput" placeholder="Describe your symptoms for a remedy check...">
                    <button id="sendButton"><i class="fas fa-paper-plane"></i></button>
                </div>
            </div>
        </section>

        <!-- SETTINGS SECTION (Placeholder) -->
        <section id="section-settings" class="content-section">
            <h2 style="color: var(--secondary-color);">Settings</h2>
            <div class="glass-card">
                <p>Configure your account and privacy settings here.</p>
                <p style="opacity:0.6;">(Feature under development)</p>
            </div>
        </section>
    </div>

    <!-- Firebase and Application Logic -->
    <script type="module">
        // Mandatory Firebase imports
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously, signInWithCustomToken, onAuthStateChanged, signOut } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, setLogLevel } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        // Global variables provided by the environment
        const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';
        const firebaseConfig = typeof __firebase_config !== 'undefined' ? JSON.parse(__firebase_config) : null;
        const initialAuthToken = typeof __initial_auth_token !== 'undefined' ? __initial_auth_token : null;

        let app, db, auth;
        let currentUserId = 'Loading...';
        let chatHistory = []; // Conversation history for the chat assistant

        // --- GEMINI API Configuration ---
        const API_BASE_URL = "https://generativelanguage.googleapis.com/v1beta/models/";
        const API_KEY = ""; // Provided by the Canvas environment
        const ANALYSIS_MODEL = "gemini-2.5-flash-preview-05-20"; // Model for structured analysis
        const CHAT_MODEL = "gemini-2.5-flash-preview-05-20"; // Model for conversational chat

        // --- GEMINI SYSTEM INSTRUCTIONS ---
        const ANALYSIS_SYSTEM_INSTRUCTION = "You are an expert AI Homeopathy analyst. Your task is to analyze the provided raw symptom report or health data and generate a concise, structured JSON summary of key symptomatic findings and a primary constitutional remedy recommendation. Focus on the totality of symptoms, modalities (worse/better by), and mental/emotional state to suggest the most appropriate single remedy. Do not include any text outside the JSON object.";
        
        const CHAT_SYSTEM_INSTRUCTION = "You are a friendly, concise, and helpful AI Homeopathy Assistant. You specialize in analyzing symptoms based on homeopathic principles, suggesting potential remedies (e.g., Arnica 30C), checking remedy incompatibilities, and offering general wellness tips congruent with homeopathy. Keep your responses short and encouraging. Always state that suggested remedies are not a substitute for consulting a qualified homeopath or doctor.";

        // --- STRUCTURED RESPONSE SCHEMA FOR ANALYSIS ---
        const ANALYSIS_RESPONSE_SCHEMA = {
            type: "OBJECT",
            properties: {
                "reportTitle": { "type": "STRING", "description": "A concise title for the analyzed report (e.g., 'Acute Symptom Analysis')." },
                "analysisDate": { "type": "STRING", "description": "The current date or date derived from the report, in YYYY-MM-DD format." },
                "suggestedProblems": {
                    "type": "ARRAY",
                    "description": "A list of identified symptom patterns or constitutional types.",
                    "items": {
                        "type": "OBJECT",
                        "properties": {
                            "type": { "type": "STRING", "description": "PATTERN (for symptom clusters) or CONSTITUTIONAL (for type matches)." },
                            "description": { "type": "STRING", "description": "The description of the symptom pattern or constitutional match (e.g., 'Acute pain with bruising tendency, key modality: worse from motion')." }
                        }
                    }
                },
                "remedyRecommendations": {
                    "type": "ARRAY",
                    "description": "A list of primary homeopathic remedies and wellness recommendations.",
                    "items": {
                        "type": "OBJECT",
                        "properties": {
                            "name": { "type": "STRING", "description": "Name of the remedy or recommendation (e.g., 'Arnica Montana 30C', 'Hydration Focus')." },
                            "details": { "type": "STRING", "description": "Potency, dosage/instruction details, or a short description of the wellness change needed." },
                            "actionRequired": { "type": "BOOLEAN", "description": "True if this is a new remedy/action the user should add to their schedule, false otherwise." }
                        }
                    }
                }
            },
            "propertyOrdering": ["reportTitle", "analysisDate", "suggestedProblems", "remedyRecommendations"]
        };

        // Initialize Firebase and Auth
        if (firebaseConfig) {
            try {
                app = initializeApp(firebaseConfig);
                auth = getAuth(app);
                db = getFirestore(app);
                setLogLevel('debug'); // Enable Firestore logging

                onAuthStateChanged(auth, async (user) => {
                    if (user) {
                        currentUserId = user.uid;
                        document.getElementById('userIdDisplay').textContent = `User ID: ${currentUserId}`;
                        console.log("Authenticated with user ID:", currentUserId);
                    } else {
                        // Attempt to sign in using custom token or anonymously
                        if (initialAuthToken) {
                            await signInWithCustomToken(auth, initialAuthToken);
                        } else {
                            await signInAnonymously(auth);
                        }
                    }
                });
            } catch (error) {
                console.error("Firebase Initialization Error:", error);
                document.getElementById('userIdDisplay').textContent = `User ID: Auth Error`;
            }
        } else {
            document.getElementById('userIdDisplay').textContent = `User ID: Config Missing`;
        }

        document.addEventListener('DOMContentLoaded', () => {
            setupNavigation();
            initChart();
            setupSidebarToggle();
            showDefaultAnalysis(); // Load the default analysis on startup
            setupChatListeners(); // Initialize chat listeners
        });

        // --- UI UTILITIES ---

        function setupSidebarToggle() {
            const sidebar = document.getElementById('sidebar');
            const toggle = document.getElementById('sidebarToggle');
            const mainContent = document.getElementById('mainContent');

            toggle.addEventListener('click', () => {
                const isCollapsed = sidebar.classList.toggle('collapsed');
                if (window.innerWidth <= 600) {
                    sidebar.classList.toggle('open');
                    if (sidebar.classList.contains('open')) {
                        mainContent.style.marginLeft = '250px';
                    } else {
                        mainContent.style.marginLeft = '0';
                    }
                } else {
                    mainContent.style.marginLeft = isCollapsed ? '80px' : '250px';
                }
            });
            
            if (window.innerWidth <= 600) {
                sidebar.classList.add('collapsed');
                mainContent.style.marginLeft = '0';
            }
        }

        function setupNavigation() {
            const navLinks = document.querySelectorAll('.nav-link');
            const sections = document.querySelectorAll('.content-section');
            const pageTitle = document.getElementById('pageTitle');

            navLinks.forEach(link => {
                link.addEventListener('click', (e) => {
                    // Check if the link is the logout or switch system link and let default behavior take over if no section is defined
                    if (!link.getAttribute('data-section') && link.getAttribute('href') !== '#') {
                        return; 
                    }
                    
                    e.preventDefault();
                    
                    navLinks.forEach(l => l.classList.remove('active'));
                    link.classList.add('active');

                    const targetSectionId = link.getAttribute('data-section');
                    sections.forEach(section => {
                        section.classList.remove('active');
                    });
                    
                    if (targetSectionId) {
                        document.getElementById(targetSectionId).classList.add('active');
                    
                        pageTitle.textContent = link.querySelector('span') ? link.querySelector('span').textContent : 'Dashboard';
                    }

                    if (window.innerWidth <= 600) {
                        const sidebar = document.getElementById('sidebar');
                        sidebar.classList.remove('open');
                        document.getElementById('mainContent').style.marginLeft = '0';
                    }
                });
            });
        }

        function initChart() {
            const ctx = document.getElementById('symptomChart');
            if (!ctx) return;

            new Chart(ctx, {
                type: 'bar',
                data: {
                    labels: ['Mon', 'Tue', 'Wed', 'Thu', 'Fri', 'Sat', 'Sun'],
                    datasets: [{
                        label: 'Symptom Intensity (1-10)',
                        data: [5, 4, 6, 3, 2, 3, 1],
                        backgroundColor: 'var(--primary-color)',
                        borderColor: 'var(--primary-color)',
                        borderWidth: 1,
                        borderRadius: 5,
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: {
                            display: false
                        }
                    },
                    scales: {
                        y: {
                            beginAtZero: true,
                            max: 10,
                            grid: { color: 'rgba(255, 255, 255, 0.1)' },
                            ticks: { color: 'var(--text-light)' }
                        },
                        x: {
                            grid: { display: false },
                            ticks: { color: 'var(--text-light)' }
                        }
                    }
                }
            });
        }
        
        // Custom Modal implementation (instead of alert/confirm)
        function showModal(title, message, isLoading = false) {
            let modal = document.getElementById('customModal');
            if (!modal) {
                modal = document.createElement('div');
                modal.id = 'customModal';
                modal.className = 'modal-overlay';
                modal.innerHTML = `
                    <div class="modal-content glass-card">
                        <h4 id="modalTitle"></h4>
                        <div id="modalSpinner" class="loading-spinner" style="display:none;"></div>
                        <p id="modalMessage"></p>
                        <button id="modalCloseBtn" class="btn-primary" style="margin-top: 20px;">Close</button>
                    </div>
                `;
                document.body.appendChild(modal);
            }
            
            const spinner = document.getElementById('modalSpinner');
            const closeBtn = document.getElementById('modalCloseBtn');
            
            document.getElementById('modalTitle').textContent = title;
            document.getElementById('modalMessage').textContent = message;
            
            if (isLoading) {
                spinner.style.display = 'block';
                closeBtn.style.display = 'none';
            } else {
                spinner.style.display = 'none';
                closeBtn.style.display = 'block';
                closeBtn.onclick = () => modal.style.display = 'none';
            }
            
            modal.style.display = 'flex';
        }


        // --- FIREBASE LOGIC ---

        // Exposed globally to be callable from the static HTML element
        window.logout = function() {
            if (auth) {
                signOut(auth).then(() => {
                    showModal('Logged Out', 'You have been successfully logged out. Redirecting to index.html...', false);
                    setTimeout(() => {
                        window.location.href = "index.html"; 
                    }, 1500);
                }).catch(error => {
                    console.error("Logout Error:", error);
                    showModal('Logout Failed', `Could not sign out: ${error.message}`);
                });
            } else {
                // Fallback for non-auth environments to fulfill the redirect requirement
                showModal('Logout', 'Logging out (Auth not initialized). Redirecting to index.html...', false);
                setTimeout(() => {
                    window.location.href = "index.html"; 
                }, 1500);
            }
        }
        
        // --- GEMINI API FUNCTIONALITY (STRUCTURED DATA) ---

        /**
         * Generic function to call the Gemini API with structured output.
         */
        async function geminiApiCall(contents, schema, systemInstruction, modelName, maxRetries = 3) {
            const url = `${API_BASE_URL}${modelName}:generateContent?key=${API_KEY}`;
            
            const payload = {
                contents: contents,
                systemInstruction: { parts: [{ text: systemInstruction }] },
                generationConfig: {
                    responseMimeType: "application/json",
                    responseSchema: schema
                }
            };

            for (let attempt = 0; attempt < maxRetries; attempt++) {
                try {
                    const response = await fetch(url, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify(payload)
                    });

                    if (!response.ok) {
                        if (response.status === 429 && attempt < maxRetries - 1) {
                            const delay = Math.pow(2, attempt) * 1000 + Math.random() * 1000;
                            await new Promise(resolve => setTimeout(resolve, delay));
                            continue;
                        }
                        console.error(`API Call Error: Status ${response.status}`, await response.text());
                        throw new Error(`API call failed with status ${response.status}`);
                    }

                    const result = await response.json();
                    const jsonText = result.candidates?.[0]?.content?.parts?.[0]?.text;
                    if (jsonText) {
                        return JSON.parse(jsonText);
                    }
                    throw new Error("API response was missing expected JSON content.");

                } catch (error) {
                    console.error(`Attempt ${attempt + 1} failed:`, error);
                    if (attempt === maxRetries - 1) throw error;
                }
            }
            throw new Error("Gemini API call failed after multiple retries.");
        }


        /**
         * Handles analyzing the uploaded file content using the Gemini API.
         * Supports Text, PDF, and Image files.
         */
        window.analyzeUploadedReport = async function(file) {
            if (!file) {
                showModal('Upload Error', 'No file selected.');
                return;
            }

            const isTextFile = file.type.startsWith('text/') || file.name.endsWith('.md');
            const isImageOrPDF = file.type.startsWith('image/') || file.type === 'application/pdf';
            const reader = new FileReader();

            showModal('AI Analysis Initiated', `Processing report: "${file.name}". This may take a moment...`, true); 

            try {
                const reportContent = await new Promise((resolve, reject) => {
                    reader.onload = (e) => resolve(e.target.result);
                    reader.onerror = reject;

                    if (isTextFile) {
                        reader.readAsText(file);
                    } else if (isImageOrPDF) {
                        if (file.size > 10 * 1024 * 1024) {
                            throw new Error("File is too large. Max size is 10MB for image/PDF reports.");
                        }
                        reader.readAsDataURL(file);
                    } else {
                        reject(new Error("Unsupported file type. Please upload a text, image (JPG/PNG), or PDF file."));
                    }
                });

                let contents;
                const userPrompt = "Analyze this health report or symptom diary. Identify the primary symptom pattern and suggest a constitutional or acute homeopathic remedy based on the principles of similia. Provide the results in the required JSON structure only.";

                if (isTextFile) {
                    contents = [{ parts: [{ text: `${userPrompt}\n\n--- REPORT TEXT ---\n${reportContent}` }] }];
                } else if (isImageOrPDF) {
                    const [mimeType, base64Data] = reportContent.split(';base64,');

                    if (!base64Data) {
                        throw new Error("Failed to extract Base64 data from file.");
                    }

                    contents = [{ 
                        parts: [
                            { text: userPrompt },
                            {
                                inlineData: {
                                    mimeType: file.type,
                                    data: base64Data
                                }
                            }
                        ]
                    }];
                } else {
                    throw new Error("File type not supported for analysis.");
                }


                const analysisData = await geminiApiCall(
                    contents, 
                    ANALYSIS_RESPONSE_SCHEMA, 
                    ANALYSIS_SYSTEM_INSTRUCTION,
                    ANALYSIS_MODEL
                );

                addAnalyzedRecordToUI(file.name, analysisData.reportTitle);
                renderAnalysisResults(analysisData);

                showModal('Analysis Complete', `Successfully analyzed "${analysisData.reportTitle}". Results displayed in the AI Assistant tab.`, false);
                
                document.querySelector('[data-section="section-ai-assistant"]').click();

            } catch (error) {
                console.error("Full analysis error:", error);
                showModal('Analysis Failed', `Could not complete analysis. Error: ${error.message || 'Check console for details.'}`, false);
            } finally {
                document.getElementById('reportFileInput').value = '';
            }
        }
        
        /**
         * Renders the simulated analysis results based on the Gemini API output structure.
         */
        function renderAnalysisResults(analysisData) {
            const card = document.getElementById('analysisOutputCard');
            const problemsSegment = card.querySelector('.problems-suggested');
            const remediesSegment = card.querySelector('.remedies-suggested');

            if (!analysisData || !analysisData.reportTitle) {
                showDefaultAnalysis();
                return;
            }
            
            // Animate transition
            card.style.opacity = 0;
            setTimeout(() => {
                card.querySelector('h3').textContent = analysisData.reportTitle;
                card.querySelector('.analysis-date').textContent = `Last Analyzed: ${analysisData.analysisDate || new Date().toLocaleDateString()}`;

                // 1. Symptom Patterns/Constitutional Types
                let problemsHtml = '<h4>Identified Constitutional Pattern:</h4>';
                if (analysisData.suggestedProblems && analysisData.suggestedProblems.length > 0) {
                    analysisData.suggestedProblems.forEach(p => {
                        const isAlert = p.type && p.type.toUpperCase() === 'PATTERN';
                        problemsHtml += `
                            <div class="suggestion ${isAlert ? 'alert' : ''}">
                                <i class="fas ${isAlert ? 'fa-star' : 'fa-check-circle'}"></i> 
                                ${p.description}
                            </div>
                        `;
                    });
                } else {
                    problemsHtml += '<div class="suggestion"><i class="fas fa-search"></i> Needs more detailed symptomology for pattern matching.</div>';
                }
                problemsSegment.innerHTML = problemsHtml;

                // 2. Remedy/Wellness Recommendations
                let remediesHtml = '<h4>AI Remedy & Wellness Recommendations:</h4>';
                if (analysisData.remedyRecommendations && analysisData.remedyRecommendations.length > 0) {
                    analysisData.remedyRecommendations.forEach(m => {
                        const icon = m.name.toLowerCase().includes('wellness') || m.name.toLowerCase().includes('dietary') ? 'fa-sun' : 'fa-leaf';
                        const buttonHtml = m.actionRequired ? `<button class="btn-add-remedy">Add to Schedule</button>` : `<div>&nbsp;</div>`;
                        remediesHtml += `
                            <div class="remedy-item">
                                <div>
                                    <i class="fas ${icon}"></i> **${m.name}:** ${m.details}
                                </div>
                                ${buttonHtml}
                            </div>
                        `;
                    });
                } else {
                    remediesHtml += '<div class="remedy-item" style="border-bottom: none;"><i class="fas fa-robot"></i> No specific remedy recommended without further detail.</div>';
                }
                remediesSegment.innerHTML = remediesHtml;

                card.style.opacity = 1;
            }, 300);
        }

        /**
         * Simulates adding the newly analyzed record to the records list.
         */
        function addAnalyzedRecordToUI(fileName, reportTitle) {
            const listContainer = document.getElementById('recordsListContainer');
            const newRecordId = `record-${Date.now()}`;
            const date = new Date().toLocaleDateString();
            const displayTitle = reportTitle || `New Report: ${fileName}`;

            const newRecordHtml = `
                <div id="${newRecordId}" class="record-card glass-card">
                    <div class="record-info">
                        <div class="record-name">${displayTitle}</div>
                        <div class="record-details">Custom Upload • ${date} • **AI Analysis Complete**</div>
                    </div>
                    <div class="record-actions">
                        <button class="btn-icon" title="View"><i class="fas fa-eye"></i></button>
                        <button class="btn-icon" title="Download"><i class="fas fa-download"></i></button>
                        <button class="btn-icon btn-ai-analyze" title="Rerun AI Analysis" onclick="showDefaultAnalysis()">
                            <i class="fas fa-brain"></i>
                        </button>
                    </div>
                </div>
            `;
            listContainer.insertAdjacentHTML('afterbegin', newRecordHtml);
        }
        
        /**
         * Loads a default, simulated analysis result for the static records.
         */
        function showDefaultAnalysis() {
            const defaultAnalysis = {
                reportTitle: "Simulated Symptom Analysis",
                analysisDate: "Oct 1, 2025",
                suggestedProblems: [
                    { "type": "PATTERN", "description": "Symptoms worse from cold, damp weather, better from warm applications. Indicates a Rhus Tox-like pattern." },
                    { "type": "CONSTITUTIONAL", "description": "Mental State: Anxious, restless, and fearful." }
                ],
                remedyRecommendations: [
                    { "name": "Rhus Toxicodendron 30C", "details": "4 pellets, twice daily until improvement. Stop on relief.", "actionRequired": true },
                    { "name": "Hydration Focus", "details": "Maintain high fluid intake to support detoxification.", "actionRequired": true },
                    { "name": "Wellness Tip", "details": "Gentle, repetitive motion helps alleviate joint stiffness.", "actionRequired": false }
                ]
            };
            renderAnalysisResults(defaultAnalysis);
        }

        // --- CHAT FUNCTIONALITY ---

        /**
         * Renders a message to the chat interface.
         */
        function appendMessage(sender, text, isHtml = false) {
            const container = document.querySelector('.message-container');
            const messageDiv = document.createElement('div');
            messageDiv.className = `${sender}-message`;
            
            const iconClass = sender === 'ai' ? 'fa-robot' : 'fa-user-circle';
            
            if (text !== '...') {
                chatHistory.push({ role: sender === 'ai' ? 'model' : 'user', parts: [{ text: text }] });
            }

            messageDiv.innerHTML = `
                <div class="message-icon"><i class="fas ${iconClass}"></i></div>
                <div class="message-content">
                    ${isHtml ? text : `<p>${text}</p>`}
                </div>
            `;
            container.appendChild(messageDiv);
            container.scrollTop = container.scrollHeight;
            return messageDiv;
        }

        function setupChatListeners() {
            const chatInput = document.getElementById('chatInput');
            const sendButton = document.getElementById('sendButton');

            sendButton.addEventListener('click', handleChatSubmit);
            chatInput.addEventListener('keypress', (e) => {
                if (e.key === 'Enter') {
                    e.preventDefault();
                    handleChatSubmit();
                }
            });
        }

        async function handleChatSubmit() {
            const chatInput = document.getElementById('chatInput');
            const userQuery = chatInput.value.trim();

            if (!userQuery) return;

            // 1. Display user message
            appendMessage('user', userQuery);
            chatInput.value = '';
            chatInput.disabled = true;
            sendButton.disabled = true;

            // 2. Display loading indicator
            const loadingMessageElement = appendMessage('ai', '...', true);
            loadingMessageElement.querySelector('.message-content').classList.add('loading-pulse');

            try {
                // 3. Call Gemini Chat API
                const aiResponseText = await callGeminiChat(userQuery);

                // 4. Update display
                loadingMessageElement.remove();
                appendMessage('ai', aiResponseText);

            } catch (error) {
                console.error("AI Chat Error:", error);
                loadingMessageElement.remove();
                appendMessage('ai', "Sorry, I'm having trouble connecting to the AI Assistant right now. Please check your network or try refreshing.", true);
            } finally {
                chatInput.disabled = false;
                sendButton.disabled = false;
                chatInput.focus();
            }
        }

        /**
         * Handles the actual API call for conversational chat.
         */
        async function callGeminiChat(prompt, maxRetries = 3) {
            const url = `${API_BASE_URL}${CHAT_MODEL}:generateContent?key=${API_KEY}`;
            
            const payload = {
                contents: chatHistory, 
                systemInstruction: { parts: [{ text: CHAT_SYSTEM_INSTRUCTION }] }
            };

            for (let attempt = 0; attempt < maxRetries; attempt++) {
                try {
                    const response = await fetch(url, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify(payload)
                    });

                    if (!response.ok) {
                        if (response.status === 429 && attempt < maxRetries - 1) {
                            const delay = Math.pow(2, attempt) * 1000 + Math.random() * 1000;
                            await new Promise(resolve => setTimeout(resolve, delay));
                            continue;
                        }
                        throw new Error(`API call failed with status ${response.status}`);
                    }

                    const result = await response.json();
                    const text = result.candidates?.[0]?.content?.parts?.[0]?.text;
                    if (text) {
                        return text;
                    }
                    throw new Error("API response was missing expected text content.");

                } catch (error) {
                    console.error(`Attempt ${attempt + 1} failed:`, error);
                    if (attempt === maxRetries - 1) throw error;
                }
            }
            throw new Error("Gemini Chat API call failed after multiple retries.");
        }

    </script>
</body>
</html>
