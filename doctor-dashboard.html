<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Doctor Dashboard | AI-Powered HealthUnify</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    
    <style>
        /* CSS adapted for a modern, dark 'doctor-theme' with glass effects */
        :root {
            --primary-color: #0078D4; /* Microsoft Blue */
            --secondary-color: #00B7C3; /* Teal */
            --background-dark: #121212;
            --surface-dark: #1e1e1e;
            --card-dark: #2c2c2c;
            --text-light: #ffffff;
            --text-secondary: #aaaaaa;
            --glass-bg: rgba(255, 255, 255, 0.05);
            --glass-border: rgba(255, 255, 255, 0.1);
            --shadow: 0 4px 12px rgba(0, 0, 0, 0.4);
            font-family: 'Inter', sans-serif;
        }

        body {
            background-color: var(--background-dark);
            color: var(--text-light);
            margin: 0;
            padding: 0;
            display: flex;
            height: 100vh;
            overflow: hidden;
            font-size: 16px;
        }

        .sidebar {
            width: 280px;
            min-width: 280px;
            transition: width 0.3s ease-in-out, min-width 0.3s ease-in-out;
            background: var(--surface-dark);
            border-right: 1px solid var(--glass-border);
            display: flex;
            flex-direction: column;
            overflow-y: auto;
        }

        .sidebar.collapsed {
            width: 80px;
            min-width: 80px;
        }

        .sidebar-header {
            display: flex;
            align-items: center;
            padding: 20px 15px;
            border-bottom: 1px solid var(--glass-border);
        }

        .sidebar-logo {
            width: 40px;
            height: 40px;
            border-radius: 8px;
            margin-right: 10px;
        }

        .logo-text {
            flex-grow: 1;
            font-size: 1.5em;
            font-weight: 700;
            white-space: nowrap;
            overflow: hidden;
            color: var(--text-light);
        }

        .sidebar.collapsed .logo-text,
        .sidebar.collapsed .nav-item span {
            display: none;
        }

        .sidebar-toggle {
            background: none;
            border: none;
            color: var(--text-light);
            font-size: 1.2em;
            cursor: pointer;
            padding: 5px;
            border-radius: 6px;
            transition: background 0.2s;
        }

        .sidebar-toggle:hover {
            background: var(--card-dark);
        }

        .sidebar-nav {
            padding: 10px 0;
            flex-grow: 1;
        }

        .nav-item {
            display: flex;
            align-items: center;
            padding: 12px 20px;
            cursor: pointer;
            color: var(--text-secondary);
            text-decoration: none;
            transition: background 0.2s, color 0.2s;
            border-left: 4px solid transparent;
            margin: 5px 0;
        }

        .nav-item:hover {
            background: rgba(255, 255, 255, 0.08);
            color: var(--text-light);
        }

        .nav-item.active {
            background: rgba(0, 119, 212, 0.2);
            border-left: 4px solid var(--primary-color);
            color: var(--primary-color);
        }

        .nav-item i {
            width: 30px;
            text-align: center;
            font-size: 1.1em;
            margin-right: 15px;
        }
        
        .sidebar.collapsed .nav-item {
            justify-content: center;
            padding: 12px 0;
        }

        .sidebar.collapsed .nav-item i {
            margin-right: 0;
        }

        .main-container {
            flex-grow: 1;
            display: flex;
            flex-direction: column;
            overflow: hidden;
        }

        .header {
            padding: 15px 30px;
            background: var(--surface-dark);
            border-bottom: 1px solid var(--glass-border);
            display: flex;
            justify-content: space-between;
            align-items: center;
            z-index: 10;
        }

        .header-title {
            font-size: 1.5em;
            font-weight: 600;
            color: var(--text-light);
        }

        .profile-menu button {
            background-color: var(--primary-color);
            color: var(--text-light);
            border: none;
            padding: 10px 20px;
            border-radius: 8px;
            cursor: pointer;
            font-weight: 500;
            transition: background-color 0.2s, transform 0.1s;
        }

        .profile-menu button:hover {
            background-color: #0063ad;
        }

        .content {
            flex-grow: 1;
            padding: 20px;
            overflow-y: auto;
        }

        .content-section {
            display: none;
            height: 100%;
        }

        .content-section.active {
            display: block;
        }

        /* ----- AI Specific Styles ----- */

        .ai-container {
            display: flex;
            flex-direction: column;
            height: 100%;
            gap: 20px;
        }

        /* --- Chat Window for AI Assistant --- */
        .chat-window {
            height: calc(100vh - 160px); /* Adjust based on header/padding */
            display: flex;
            flex-direction: column;
            background: var(--card-dark);
            border-radius: 12px;
            box-shadow: var(--shadow);
            overflow: hidden;
        }

        .chat-messages {
            flex-grow: 1;
            padding: 20px;
            overflow-y: auto;
            display: flex;
            flex-direction: column;
            gap: 15px;
            scroll-behavior: smooth;
        }

        .chat-input-area {
            display: flex;
            padding: 15px;
            border-top: 1px solid var(--surface-dark);
            background: var(--surface-dark);
        }

        .chat-input-area textarea {
            flex-grow: 1;
            padding: 10px 15px;
            border: none;
            border-radius: 20px;
            background: var(--card-dark);
            color: var(--text-light);
            resize: none;
            max-height: 100px;
            outline: none;
            margin-right: 10px;
        }

        .chat-input-area button {
            background-color: var(--secondary-color);
            color: white;
            border: none;
            width: 45px;
            height: 45px;
            border-radius: 50%;
            cursor: pointer;
            transition: background-color 0.2s;
        }

        .chat-input-area button:hover {
            background-color: #0099a4;
        }

        .message {
            max-width: 85%;
            padding: 12px 18px;
            border-radius: 18px;
            font-size: 0.95em;
            line-height: 1.4;
            word-wrap: break-word;
            box-shadow: 0 1px 3px rgba(0, 0, 0, 0.1);
        }

        .user-message {
            align-self: flex-end;
            background-color: var(--primary-color);
            color: white;
            border-bottom-right-radius: 4px;
        }

        .ai-message {
            align-self: flex-start;
            background-color: var(--card-dark);
            color: var(--text-light);
            border: 1px solid var(--glass-border);
            border-bottom-left-radius: 4px;
        }
        
        .ai-message strong {
            color: var(--secondary-color);
        }

        /* --- Analysis Card for Clinical Analysis --- */

        .analysis-card {
            background: var(--card-dark);
            border-radius: 12px;
            padding: 30px;
            box-shadow: var(--shadow);
            margin-bottom: 20px;
        }
        
        .analysis-card h3 {
            margin-top: 0;
            color: var(--primary-color);
        }

        .analysis-card textarea {
            width: 100%;
            min-height: 250px;
            padding: 15px;
            background: var(--surface-dark);
            border: 1px solid var(--glass-border);
            border-radius: 8px;
            color: var(--text-light);
            resize: vertical;
            font-family: 'Inter', sans-serif;
            outline: none;
        }
        
        .analysis-card button {
            margin-top: 15px;
            background-color: var(--secondary-color);
            color: white;
            border: none;
            padding: 12px 25px;
            border-radius: 8px;
            cursor: pointer;
            font-weight: 600;
            transition: background-color 0.2s;
        }
        
        .analysis-card button:hover {
            background-color: #0099a4;
        }

        .analysis-output {
            margin-top: 20px;
            padding: 20px;
            background: var(--surface-dark);
            border-radius: 8px;
            min-height: 150px;
            white-space: pre-wrap;
            border: 1px solid var(--glass-border);
        }
        
        .analysis-output h4 {
            color: var(--primary-color);
            margin-top: 0;
            border-bottom: 1px solid var(--glass-border);
            padding-bottom: 10px;
            margin-bottom: 15px;
        }

        /* Loading Spinner */
        .spinner {
            border: 4px solid rgba(255, 255, 255, 0.3);
            border-radius: 50%;
            border-top: 4px solid var(--primary-color);
            width: 30px;
            height: 30px;
            animation: spin 1s linear infinite;
            display: none;
            margin: 15px auto;
        }

        .spinner.active {
            display: block;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        .toast {
            position: fixed;
            bottom: 20px;
            right: 20px;
            padding: 15px 25px;
            border-radius: 8px;
            color: white;
            font-weight: 500;
            opacity: 0;
            transition: opacity 0.5s, transform 0.5s;
            transform: translateY(20px);
            z-index: 1000;
        }

        .toast.show {
            opacity: 1;
            transform: translateY(0);
        }

        .toast.success { background-color: #28a745; }
        .toast.error { background-color: #dc3545; }
        .toast.info { background-color: var(--primary-color); }
    </style>
</head>
<body class="dashboard-body doctor-theme">
   
    <!-- Sidebar -->
    <aside class="sidebar" id="sidebar">
        <div class="sidebar-header">
            <!-- Placeholder for Logo - removed image/logo.png reference -->
            <div class="logo-text">
                <span style="color: var(--primary-color);">Health</span><span style="color: var(--secondary-color);">Unify</span>
            </div>
            <button class="sidebar-toggle" id="sidebarToggle">
                <i class="fas fa-bars"></i>
            </button>
        </div>

        <nav class="sidebar-nav">
            <div class="nav-item active" data-section="dashboard" onclick="switchSection('dashboard')">
                <i class="fas fa-chart-line"></i>
                <span>Dashboard</span>
            </div>
            <div class="nav-item" data-section="patients" onclick="switchSection('patients')">
                <i class="fas fa-users"></i>
                <span>My Patients</span>
            </div>
            <div class="nav-item" data-section="appointments" onclick="switchSection('appointments')">
                <i class="fas fa-calendar-check"></i>
                <span>Appointments</span>
            </div>
            <div class="nav-item" data-section="consultations" onclick="switchSection('consultations')">
                <i class="fas fa-notes-medical"></i>
                <span>Consultations</span>
            </div>
            
            <!-- NEW: AI Assistant -->
            <div class="nav-item" data-section="ai-assistant" onclick="switchSection('ai-assistant')">
                <i class="fas fa-robot"></i>
                <span>AI Assistant</span>
            </div>
            
            <!-- NEW: AI Clinical Analysis -->
            <div class="nav-item" data-section="clinical-analysis" onclick="switchSection('clinical-analysis')">
                <i class="fas fa-microscope"></i>
                <span>Clinical Analysis</span>
            </div>
            
            <div class="nav-item" data-section="schedule" onclick="switchSection('schedule')">
                <i class="fas fa-clock"></i>
                <span>My Schedule</span>
            </div>
            <div class="nav-item" data-section="messages" onclick="switchSection('messages')">
                <i class="fas fa-inbox"></i>
                <span>Messages</span>
            </div>
            <div class="nav-item" data-section="settings" onclick="switchSection('settings')">
                <i class="fas fa-cog"></i>
                <span>Settings</span>
            </div>
        </nav>
        
        <div class="sidebar-footer">
            <div class="nav-item logout-button" onclick="logout()">
                <i class="fas fa-sign-out-alt"></i>
                <span>Logout</span>
            </div>
        </div>
    </aside>

    <!-- Main Content Container -->
    <div class="main-container">
        <!-- Header -->
        <header class="header">
            <h1 class="header-title" id="pageTitle">Doctor Dashboard</h1>
            <div class="profile-menu">
                <button onclick="logout()">
                    <i class="fas fa-user-circle"></i> Logout
                </button>
            </div>
        </header>

        <!-- Content Area -->
        <main class="content">
            
            <!-- Section: Dashboard (Default Active) -->
            <section id="section-dashboard" class="content-section active">
                <h2>Welcome Back, Dr. [User Name]!</h2>
                <p style="color: var(--text-secondary);">Here is a summary of your key metrics and upcoming tasks.</p>
                <div class="grid-layout">
                    <!-- Placeholder for dashboard cards -->
                    <div class="analysis-card"><h3>Today's Appointments: 5</h3></div>
                    <div class="analysis-card"><h3>Pending Follow-ups: 3</h3></div>
                    <div class="analysis-card"><h3>Recent Consultations: 12</h3></div>
                </div>
            </section>

            <!-- Placeholder Sections -->
            <section id="section-patients" class="content-section"><h2 style="color: var(--primary-color);">My Patients</h2><p>Patient list and records will appear here.</p></section>
            <section id="section-appointments" class="content-section"><h2 style="color: var(--primary-color);">Appointments</h2><p>Appointment management interface will appear here.</p></section>
            <section id="section-consultations" class="content-section"><h2 style="color: var(--primary-color);">Consultations</h2><p>Consultation history and notes will appear here.</p></section>
            <section id="section-schedule" class="content-section"><h2 style="color: var(--primary-color);">My Schedule</h2><p>Calendar and scheduling tools will appear here.</p></section>
            <section id="section-messages" class="content-section"><h2 style="color: var(--primary-color);">Messages</h2><p>Secure messaging with patients and staff will appear here.</p></section>
            <section id="section-settings" class="content-section"><h2 style="color: var(--primary-color);">Settings</h2><p>Account and application settings will appear here.</p></section>

            <!-- NEW SECTION: AI Assistant -->
            <section id="section-ai-assistant" class="content-section">
                <h2 style="color: var(--primary-color);">AI Medical Assistant</h2>
                <p style="color: var(--text-secondary);">Ask clinical questions, check drug interactions, or get quick summaries of medical literature. (Powered by Gemini with Google Search grounding).</p>

                <div class="chat-window">
                    <div class="chat-messages" id="chatMessages">
                        <div class="message ai-message">
                            <strong>AI Assistant:</strong> Hello Doctor, I am here to assist with your medical queries. How can I help you today?
                        </div>
                    </div>
                    <div class="spinner" id="assistantSpinner"></div>
                    <div class="chat-input-area">
                        <textarea id="assistantInput" placeholder="Ask a question (e.g., 'What is the standard treatment protocol for adult-onset Still’s disease?')"></textarea>
                        <button id="sendAssistantBtn" onclick="handleAssistantChat()">
                            <i class="fas fa-paper-plane"></i>
                        </button>
                    </div>
                </div>
            </section>
            
            <!-- NEW SECTION: AI Clinical Analysis -->
            <section id="section-clinical-analysis" class="content-section">
                <h2 style="color: var(--primary-color);">AI Clinical Analysis</h2>
                <p style="color: var(--text-secondary);">Paste patient notes, lab results, or imaging reports for AI-powered clinical summary, differential diagnosis, and suggested next steps.</p>

                <div class="analysis-card">
                    <h3>Input Patient Data</h3>
                    <textarea id="clinicalDataInput" placeholder="Paste patient history, lab results (e.g., 'Patient: Jane Doe, 45 y/o female. Chief Complaint: Severe headache, fever for 3 days. Lab Results: WBC 18,000, CRP 150 mg/L...')" rows="10"></textarea>
                    <button id="analyzeBtn" onclick="handleClinicalAnalysis()">
                        <i class="fas fa-brain"></i> Analyze Data
                    </button>
                    <div class="spinner" id="analysisSpinner"></div>
                </div>

                <div class="analysis-output">
                    <h4>AI Analysis Output</h4>
                    <p id="analysisOutputText" style="color: var(--text-secondary);">The detailed clinical analysis will appear here after processing.</p>
                </div>
            </section>

        </main>
    </div>

    <!-- Toast Notification Area -->
    <div id="toastContainer"></div>

    <script>
        const apiKey = "AIzaSyBydtgk8kzKmKiwikD5DxtkSo0345-G67Y"; // API key updated
        const modelName = "gemini-2.5-flash-preview-05-20";
        const apiUrl = `https://generativelanguage.googleapis.com/v1beta/models/${modelName}:generateContent?key=${apiKey}`;
        const maxRetries = 3;

        // Global function for showing toast notifications
        function showToast(message, type = 'info') {
            const container = document.getElementById('toastContainer');
            const toast = document.createElement('div');
            toast.className = `toast ${type}`;
            toast.textContent = message;
            container.appendChild(toast);

            setTimeout(() => {
                toast.classList.add('show');
            }, 10);

            setTimeout(() => {
                toast.classList.remove('show');
                setTimeout(() => {
                    container.removeChild(toast);
                }, 500);
            }, 3000);
        }

        // Core function to call the Gemini API with exponential backoff and search grounding
        async function callGeminiApi(userQuery, systemPrompt) {
            const payload = {
                contents: [{ parts: [{ text: userQuery }] }],
                tools: [{ "google_search": {} }],
                systemInstruction: {
                    parts: [{ text: systemPrompt }]
                },
            };

            for (let attempt = 0; attempt < maxRetries; attempt++) {
                try {
                    const response = await fetch(apiUrl, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify(payload)
                    });

                    if (!response.ok) {
                        if (response.status === 429 && attempt < maxRetries - 1) {
                            const delay = Math.pow(2, attempt) * 1000 + Math.random() * 1000;
                            await new Promise(resolve => setTimeout(resolve, delay));
                            continue; // Retry
                        }
                        throw new Error(`API call failed with status ${response.status}`);
                    }

                    const result = await response.json();
                    const text = result.candidates?.[0]?.content?.parts?.[0]?.text;
                    if (text) {
                        return text;
                    }
                    throw new Error("API response was missing expected text content.");

                } catch (error) {
                    console.error(`Attempt ${attempt + 1} failed:`, error);
                    if (attempt === maxRetries - 1) throw error;
                }
            }
            throw new Error("Gemini API call failed after multiple retries.");
        }

        // Function to create and append a message bubble
        function appendMessage(text, sender) {
            const chatMessages = document.getElementById('chatMessages');
            const messageDiv = document.createElement('div');
            messageDiv.className = `message ${sender}-message`;
            
            // Format AI response with Markdown for readability
            if (sender === 'ai') {
                const formattedText = text.replace(/\*\*(.*?)\*\*/g, '<strong>$1</strong>')
                                          .replace(/\n/g, '<br>');
                messageDiv.innerHTML = formattedText;
            } else {
                messageDiv.textContent = text;
            }
            
            chatMessages.appendChild(messageDiv);
            chatMessages.scrollTop = chatMessages.scrollHeight; // Auto-scroll to bottom
        }

        // AI Assistant Logic
        async function handleAssistantChat() {
            const inputElement = document.getElementById('assistantInput');
            const userQuery = inputElement.value.trim();
            const spinner = document.getElementById('assistantSpinner');
            const sendBtn = document.getElementById('sendAssistantBtn');

            if (!userQuery) {
                showToast('Please enter a question for the assistant.', 'info');
                return;
            }

            // 1. Display user message and clear input
            appendMessage(userQuery, 'user');
            inputElement.value = '';
            inputElement.disabled = true;
            sendBtn.disabled = true;
            spinner.classList.add('active');

            const systemPrompt = "You are a highly knowledgeable medical research assistant. Your primary goal is to provide concise, evidence-based, and highly accurate information to a practicing physician. Cite sources if discussing specific protocols or recent findings. Keep answers professional and structured.";

            try {
                const aiResponse = await callGeminiApi(userQuery, systemPrompt);
                // 2. Display AI response
                appendMessage(aiResponse, 'ai');
                showToast('AI response received.', 'success');
            } catch (error) {
                console.error('AI Assistant Error:', error);
                appendMessage("I apologize, but I encountered an error while processing your request. Please try again.", 'ai');
                showToast('Failed to get AI response.', 'error');
            } finally {
                // 3. Cleanup
                spinner.classList.remove('active');
                inputElement.disabled = false;
                sendBtn.disabled = false;
                inputElement.focus();
            }
        }

        // AI Clinical Analysis Logic
        async function handleClinicalAnalysis() {
            const inputElement = document.getElementById('clinicalDataInput');
            const outputElement = document.getElementById('analysisOutputText');
            const analyzeBtn = document.getElementById('analyzeBtn');
            const spinner = document.getElementById('analysisSpinner');

            const clinicalData = inputElement.value.trim();

            if (!clinicalData) {
                showToast('Please paste patient data for analysis.', 'info');
                return;
            }
            
            outputElement.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Analyzing data...';
            inputElement.disabled = true;
            analyzeBtn.disabled = true;
            spinner.classList.add('active');

            const userQuery = `Analyze the following patient data, lab results, and notes: \n\n---START DATA---\n${clinicalData}\n---END DATA---\n\nProvide a structured output containing: 1. A concise clinical summary, 2. A differential diagnosis (top 3) with brief justification, and 3. Suggested next diagnostic or therapeutic steps.`;
            
            const systemPrompt = "You are an expert clinical consultant AI. Your goal is to analyze raw clinical data (notes, labs) and provide structured, high-quality medical summaries and recommendations to a doctor. Focus on critical findings and evidence-based medicine. Output must be structured using clear section headings.";

            try {
                const aiAnalysis = await callGeminiApi(userQuery, systemPrompt);
                // 2. Display AI analysis
                outputElement.textContent = aiAnalysis;
                showToast('Clinical analysis complete.', 'success');
            } catch (error) {
                console.error('Clinical Analysis Error:', error);
                outputElement.textContent = "Error: Failed to perform clinical analysis after multiple attempts. Please check the data format or try again later.";
                showToast('Failed to perform analysis.', 'error');
            } finally {
                // 3. Cleanup
                spinner.classList.remove('active');
                inputElement.disabled = false;
                analyzeBtn.disabled = false;
            }
        }

        // --- Dashboard Navigation and Initialization ---

        function initDashboard() {
            // Initial load state
            switchSection('dashboard');
            
            // Sidebar toggle logic
            document.getElementById('sidebarToggle').addEventListener('click', function() {
                document.getElementById('sidebar').classList.toggle('collapsed');
            });
            
            // Add event listener for AI Assistant Enter key press
            document.getElementById('assistantInput').addEventListener('keypress', function(e) {
                if (e.key === 'Enter' && !e.shiftKey) {
                    e.preventDefault();
                    handleAssistantChat();
                }
            });
        }

        function switchSection(section) {
            document.querySelectorAll('.nav-item').forEach(item => {
                item.classList.remove('active');
                if (item.dataset.section === section) {
                    item.classList.add('active');
                }
            });

            document.querySelectorAll('.content-section').forEach(sec => {
                sec.classList.remove('active');
            });
            document.getElementById('section-' + section).classList.add('active');

            const titles = {
                'dashboard': 'Doctor Dashboard',
                'patients': 'My Patients',
                'appointments': 'Appointments',
                'consultations': 'Consultations',
                'ai-assistant': 'AI Medical Assistant', // New Title
                'clinical-analysis': 'AI Clinical Analysis', // New Title
                'messages': 'Messages',
                'schedule': 'My Schedule',
                'settings': 'Settings'
            };
            document.getElementById('pageTitle').textContent = titles[section];
        }

        function logout() {
            // In a real app, this would clear server session/local tokens.
            showToast('Logged out successfully!', 'success');
            // No redirection or localStorage clear for this example, just a toast.
        }
        
        // Initialize the dashboard on load
        window.onload = initDashboard;

    </script>
</body>
</html>
