<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Doctor Dashboard | HealthUnify by LuminaTech</title>
    <!-- Load Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;500;600;700;800&family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

    <!-- Consolidated Custom Styles -->
    <style>
        :root {
            --doctor-color: #1E88E5; /* Blue */
            --doctor-light: #42a5f5;
            --dashboard-bg: #f4f7fa;
            --glass-bg: rgba(255, 255, 255, 0.7);
            --glass-border: rgba(255, 255, 255, 0.2);
            --shadow-dark: rgba(0, 0, 0, 0.1);
            --shadow-light: rgba(255, 255, 255, 0.8);
        }

        body {
            font-family: 'Inter', sans-serif;
            background-color: var(--dashboard-bg);
            /* Removed flex from body to handle mobile layout stacking */
            min-height: 100vh;
        }

        .sidebar {
            background: linear-gradient(180deg, #FFFFFF 0%, #F8F9FA 100%);
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -2px rgba(0, 0, 0, 0.06);
            height: 100vh;
            /* Desktop Styles: Sticky, full height, width 64 */
            position: sticky;
            top: 0;
            overflow-y: auto;
            transition: transform 0.3s ease-in-out;
        }

        /* Mobile Styles for Sidebar (Activated when 'open' class is added by JS) */
        @media (max-width: 767px) {
            .sidebar {
                position: fixed;
                width: 75%; /* Takes up 3/4 of screen */
                z-index: 50;
                /* Initially off-screen */
                transform: translateX(-100%);
            }
            .sidebar.open {
                /* Slide in */
                transform: translateX(0);
                box-shadow: 4px 0 10px rgba(0, 0, 0, 0.3);
            }
        }

        .nav-item.active {
            background-color: var(--doctor-color);
            color: white !important;
            box-shadow: 0 4px 10px rgba(30, 136, 229, 0.4);
        }

        .nav-item.active .fa-solid, .nav-item.active .fa-regular, .nav-item.active .fa-brain {
            color: white !important;
        }

        .main-content-area {
            min-height: 100vh;
            background-color: var(--dashboard-bg);
            padding: 24px;
        }

        /* Adjust padding for mobile to clear the fixed menu button */
        @media (max-width: 767px) {
             .main-content-area {
                padding: 1rem;
                padding-top: 5rem; /* Add space for the fixed menu button/header */
            }
        }

        .content-section {
            display: none;
            opacity: 0;
            transition: opacity 0.3s ease-in-out;
        }

        .content-section.active {
            display: block;
            opacity: 1;
        }

        .card {
            background-color: white;
            border-radius: 12px;
            box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.1), 0 4px 6px -4px rgba(0, 0, 0, 0.1);
        }

        /* Toast Styles */
        #toast-container {
            position: fixed;
            bottom: 20px;
            right: 20px;
            z-index: 1000;
        }

        .toast {
            padding: 12px 20px;
            border-radius: 8px;
            margin-top: 10px;
            animation: slideIn 0.3s ease-out, fadeOut 0.5s ease-in 4.5s forwards;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
        }

        .toast.success { background-color: #4CAF50; color: white; }
        .toast.error { background-color: #F44336; color: white; }
        .toast.info { background-color: #2196F3; color: white; }

        @keyframes slideIn {
            from { transform: translateX(100%); }
            to { transform: translateX(0); }
        }

        @keyframes fadeOut {
            from { opacity: 1; }
            to { opacity: 0; display: none; }
        }

        /* Loading Spinner */
        .spinner {
            border: 4px solid rgba(255, 255, 255, 0.3);
            border-radius: 50%;
            border-top: 4px solid white;
            width: 24px;
            height: 24px;
            animation: spin 1s linear infinite;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
    </style>
</head>
<body>

    <!-- Toast Container -->
    <div id="toast-container"></div>
    
    <!-- Mobile Menu Toggle Button -->
    <button id="menuToggle" onclick="toggleSidebar()" class="fixed top-4 left-4 z-50 p-3 bg-blue-600 text-white rounded-full shadow-lg md:hidden">
        <i class="fas fa-bars text-xl"></i>
    </button>

    <!-- Main App Container: Flex layout on medium screens and up, vertical stack on mobile -->
    <div class="flex flex-col md:flex-row min-h-screen">
        
        <!-- Sidebar -->
        <!-- Added ID 'sidebar' and Tailwind classes to hide on mobile by default -->
        <div class="sidebar w-64 p-4 flex-col justify-between hidden md:flex" id="sidebar">
            <div>
                <div class="text-3xl font-extrabold text-blue-800 mb-8 flex items-center">
                    <i class="fas fa-stethoscope mr-2 text-4xl text-blue-600"></i> HealthUnify
                </div>
                
                <!-- Navigation Links -->
                <nav class="space-y-2">
                    <a href="#" class="nav-item flex items-center p-3 text-gray-700 hover:bg-blue-100/70 hover:text-blue-700 transition duration-150 rounded-lg active" data-section="dashboard" onclick="switchSection('dashboard')">
                        <i class="fas fa-home w-5 text-xl mr-4"></i> Dashboard
                    </a>
                    <a href="#" class="nav-item flex items-center p-3 text-gray-700 hover:bg-blue-100/70 hover:text-blue-700 transition duration-150 rounded-lg" data-section="patients" onclick="switchSection('patients')">
                        <i class="fas fa-user-injured w-5 text-xl mr-4"></i> My Patients
                    </a>
                    <a href="#" class="nav-item flex items-center p-3 text-gray-700 hover:bg-blue-100/70 hover:text-blue-700 transition duration-150 rounded-lg" data-section="appointments" onclick="switchSection('appointments')">
                        <i class="fas fa-calendar-check w-5 text-xl mr-4"></i> Appointments
                    </a>
                    <a href="#" class="nav-item flex items-center p-3 text-gray-700 hover:bg-blue-100/70 hover:text-blue-700 transition duration-150 rounded-lg" data-section="consultations" onclick="switchSection('consultations')">
                        <i class="fas fa-notes-medical w-5 text-xl mr-4"></i> Consultations
                    </a>
                    <a href="#" class="nav-item flex items-center p-3 text-gray-700 hover:bg-blue-100/70 hover:text-blue-700 transition duration-150 rounded-lg" data-section="messages" onclick="switchSection('messages')">
                        <i class="fas fa-comments w-5 text-xl mr-4"></i> Secure Messages
                    </a>
                    
                    <!-- NEW: AI Analysis Section -->
                    <a href="#" class="nav-item flex items-center p-3 text-gray-700 hover:bg-indigo-100/70 hover:text-indigo-700 transition duration-150 rounded-lg" data-section="analysis" onclick="switchSection('analysis')">
                        <i class="fas fa-brain w-5 text-xl mr-4"></i> Clinical AI Analysis
                    </a>
                    <!-- END NEW -->

                    <a href="#" class="nav-item flex items-center p-3 text-gray-700 hover:bg-blue-100/70 hover:text-blue-700 transition duration-150 rounded-lg" data-section="schedule" onclick="switchSection('schedule')">
                        <i class="fas fa-clock w-5 text-xl mr-4"></i> My Schedule
                    </a>
                </nav>
            </div>

            <!-- Settings and Logout -->
            <div class="mt-8 space-y-2 border-t pt-4">
                <!-- NEW: Switch System Button -->
                <button 
                    onclick="openSystemChooser()"
                    class="nav-item w-full flex items-center p-3 text-gray-700 hover:bg-blue-100/70 hover:text-blue-700 transition duration-150 rounded-lg font-semibold"
                >
                    <i class="fas fa-exchange-alt w-5 text-xl mr-4"></i> Switch System
                </button>
                <!-- END NEW -->
                
                <a href="#" class="nav-item flex items-center p-3 text-gray-700 hover:bg-blue-100/70 hover:text-blue-700 transition duration-150 rounded-lg" data-section="settings" onclick="switchSection('settings')">
                    <i class="fas fa-cog w-5 text-xl mr-4"></i> Settings
                </a>
                <a href="#" class="nav-item flex items-center p-3 text-red-500 hover:bg-red-100/70 transition duration-150 rounded-lg" onclick="logout()">
                    <i class="fas fa-sign-out-alt w-5 text-xl mr-4"></i> Logout
                </a>
            </div>
        </div>

        <!-- Main Content Area -->
        <div class="main-content-area flex-1">
            
            <!-- Header -->
            <!-- Adjusted header for better mobile responsiveness -->
            <header class="flex justify-between items-center pb-6 md:border-b border-gray-200 sticky top-0 bg-white/90 backdrop-blur-sm z-30 p-4 md:-mx-4 md:-mt-4 mb-4 rounded-b-lg shadow-md">
                <!-- Hide logo on mobile since menu button is fixed at the top left -->
                <h1 id="pageTitle" class="text-xl md:text-3xl font-extrabold text-gray-800 ml-8 md:ml-0">Doctor Dashboard</h1>
                
                <!-- Adjusted spacing and element size for mobile -->
                <div class="flex items-center space-x-2 md:space-x-4">
                    <button class="text-gray-500 hover:text-blue-600 transition duration-150 p-2 rounded-full bg-white shadow-md">
                        <i class="fas fa-bell text-lg md:text-xl"></i>
                    </button>
                    <div class="flex items-center space-x-2 cursor-pointer p-1 rounded-full hover:bg-gray-100 transition duration-150">
                        <img class="w-8 h-8 md:w-10 md:h-10 rounded-full object-cover" src="https://placehold.co/40x40/1E88E5/FFFFFF?text=Dr" alt="Dr. Avatar">
                        <div class="hidden sm:block">
                            <div class="text-sm font-semibold text-gray-800">Dr. E. Vance</div>
                            <div class="text-xs text-gray-500">Cardiologist</div>
                        </div>
                    </div>
                </div>
            </header>

            <!-- Content Sections -->

            <!-- 1. Dashboard Section (Active by default) -->
            <div id="section-dashboard" class="content-section active space-y-6">
                <!-- Stat Cards: Grid layout adjusts from 1 column on mobile to 4 on desktop -->
                <div class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-4 gap-6">
                    <!-- Stat Card 1 -->
                    <div class="card p-5 bg-blue-500 text-white flex flex-col justify-between transform transition duration-500 hover:scale-[1.02]">
                        <div class="text-xs font-medium opacity-80">Today's Appointments</div>
                        <div class="text-4xl font-extrabold my-2">12</div>
                        <div class="text-sm opacity-80 flex justify-between items-center">
                            <span>+1 New Patient</span>
                            <i class="fas fa-calendar-alt text-2xl"></i>
                        </div>
                    </div>
                    <!-- Stat Card 2 -->
                    <div class="card p-5 bg-green-500 text-white flex flex-col justify-between transform transition duration-500 hover:scale-[1.02]">
                        <div class="text-xs font-medium opacity-80">Total Patients</div>
                        <div class="text-4xl font-extrabold my-2">458</div>
                        <div class="text-sm opacity-80 flex justify-between items-center">
                            <span>+5 since last week</span>
                            <i class="fas fa-user-injured text-2xl"></i>
                        </div>
                    </div>
                    <!-- Stat Card 3 -->
                    <div class="card p-5 bg-yellow-500 text-white flex flex-col justify-between transform transition duration-500 hover:scale-[1.02]">
                        <div class="text-xs font-medium opacity-80">Consultation Hours</div>
                        <div class="text-4xl font-extrabold my-2">24h</div>
                        <div class="text-sm opacity-80 flex justify-between items-center">
                            <span>This Month</span>
                            <i class="fas fa-clock text-2xl"></i>
                        </div>
                    </div>
                    <!-- Stat Card 4 -->
                    <div class="card p-5 bg-indigo-500 text-white flex flex-col justify-between transform transition duration-500 hover:scale-[1.02]">
                        <div class="text-xs font-medium opacity-80">Open Messages</div>
                        <div class="text-4xl font-extrabold my-2">5</div>
                        <div class="text-sm opacity-80 flex justify-between items-center">
                            <span>Reply needed</span>
                            <i class="fas fa-comments text-2xl"></i>
                        </div>
                    </div>
                </div>

                <!-- Charts and Lists: Stack on mobile, side-by-side on desktop -->
                <div class="grid grid-cols-1 lg:grid-cols-3 gap-6">
                    <!-- Patient Load Chart -->
                    <div class="card p-6 lg:col-span-2">
                        <h2 class="text-xl font-semibold mb-4 text-gray-700">Monthly Patient Load</h2>
                        <div class="w-full h-80">
                            <canvas id="patientLoadChart" class="w-full h-full"></canvas>
                        </div>
                    </div>

                    <!-- Upcoming Appointments -->
                    <div class="card p-6">
                        <h2 class="text-xl font-semibold mb-4 text-gray-700">Next 3 Appointments</h2>
                        <ul class="space-y-4">
                            <li class="flex items-center justify-between p-3 border-b hover:bg-gray-50 rounded-md transition duration-150 cursor-pointer">
                                <div>
                                    <div class="font-medium text-gray-800">Mr. Robert D.</div>
                                    <div class="text-sm text-gray-500">Routine Checkup</div>
                                </div>
                                <span class="text-sm font-semibold text-blue-600">9:00 AM</span>
                            </li>
                            <li class="flex items-center justify-between p-3 border-b hover:bg-gray-50 rounded-md transition duration-150 cursor-pointer">
                                <div>
                                    <div class="font-medium text-gray-800">Ms. Sarah J.</div>
                                    <div class="text-sm text-gray-500">Post-op Follow-up</div>
                                </div>
                                <span class="text-sm font-semibold text-blue-600">10:30 AM</span>
                            </li>
                            <li class="flex items-center justify-between p-3 hover:bg-gray-50 rounded-md transition duration-150 cursor-pointer">
                                <div>
                                    <div class="font-medium text-gray-800">Mr. Ethan K.</div>
                                    <div class="text-sm text-gray-500">New Patient Consultation</div>
                                </div>
                                <span class="text-sm font-semibold text-blue-600">11:45 AM</span>
                            </li>
                        </ul>
                    </div>
                </div>
            </div>
            
            <!-- 2. My Patients Section (Placeholder) -->
            <div id="section-patients" class="content-section">
                <div class="card p-6">
                    <h2 class="text-2xl font-semibold mb-4 text-gray-700">My Patients</h2>
                    <p class="text-gray-500">List of active patients, health records, and detailed charts will appear here.</p>
                    <div class="mt-4 p-4 border rounded-lg bg-yellow-50 text-yellow-700">
                        <i class="fas fa-exclamation-triangle mr-2"></i> This section is under development.
                    </div>
                </div>
            </div>

            <!-- ... other placeholder sections (appointments, consultations, messages, schedule, settings) ... -->
            <div id="section-appointments" class="content-section"><div class="card p-6"><h2 class="text-2xl font-semibold mb-4 text-gray-700">Appointments Management</h2><p class="text-gray-500">Manage all scheduled appointments and patient queues.</p></div></div>
            <div id="section-consultations" class="content-section"><div class="card p-6"><h2 class="text-2xl font-semibold mb-4 text-gray-700">Consultations History</h2><p class="text-gray-500">Access and review past consultation notes and diagnostic summaries.</p></div></div>
            <div id="section-messages" class="content-section"><div class="card p-6"><h2 class="text-2xl font-semibold mb-4 text-gray-700">Secure Messages</h2><p class="text-gray-500">Communicate securely with patients and colleagues.</p></div></div>
            <div id="section-schedule" class="content-section"><div class="card p-6"><h2 class="text-2xl font-semibold mb-4 text-gray-700">My Schedule</h2><p class="text-gray-500">View and modify your daily and weekly work schedule.</p></div></div>
            <div id="section-settings" class="content-section"><div class="card p-6"><h2 class="text-2xl font-semibold mb-4 text-gray-700">Settings</h2><p class="text-gray-500">User profile and system configuration options.</p></div></div>


            <!-- 3. Clinical AI Analysis Section -->
            <div id="section-analysis" class="content-section">
                <div class="card p-8 space-y-6">
                    <h2 class="text-2xl font-extrabold text-indigo-700 flex items-center">
                        <i class="fas fa-brain mr-3"></i> AI-Powered Clinical Data Analysis
                    </h2>
                    <p class="text-gray-600">
                        Paste raw patient data (vitals, labs, symptoms) below. Our specialized AI will analyze the data, provide a clinical summary, highlight risks, and suggest follow-up steps. The analysis is grounded by current medical knowledge via Google Search.
                    </p>

                    <!-- Input Area -->
                    <div>
                        <label for="clinicalDataInput" class="block text-lg font-medium text-gray-700 mb-2">Patient Data Input</label>
                        <textarea id="clinicalDataInput" rows="8" class="w-full p-4 border border-gray-300 rounded-lg focus:ring-indigo-500 focus:border-indigo-500 resize-none text-sm shadow-inner" placeholder="Example data:
- Name: Elias V.
- Age: 68
- Vitals: BP 155/95 mmHg, HR 88 bpm, Temp 98.6Â°F
- Lab Results: Total Cholesterol 245 mg/dL, LDL 160 mg/dL, Glucose 115 mg/dL (fasting)
- Symptoms: Occasional shortness of breath, fatigue over the last 3 months."></textarea>
                    </div>

                    <!-- Action Button -->
                    <button id="analyzeButton" onclick="analyzeClinicalData()" class="w-full flex justify-center items-center px-6 py-3 border border-transparent text-base font-medium rounded-lg text-white bg-indigo-600 hover:bg-indigo-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-indigo-500 transition duration-150 shadow-md">
                        <span id="buttonText">Run AI Analysis</span>
                        <div id="loadingSpinner" class="spinner ml-3 hidden"></div>
                    </button>

                    <!-- Output Area -->
                    <div id="analysisOutputContainer" class="pt-6 border-t mt-6 hidden">
                        <h3 class="text-xl font-bold text-gray-800 mb-4">AI Analysis Result</h3>
                        <div id="analysisOutput" class="p-4 bg-gray-50 border border-indigo-200 rounded-lg min-h-[150px] text-gray-700 prose max-w-none">
                            <!-- AI content will be inserted here -->
                        </div>
                        <div id="citationSources" class="mt-4 text-xs text-gray-500">
                            <!-- Citations will be inserted here -->
                        </div>
                    </div>
                </div>
            </div>
            <!-- END NEW -->


        </div>
    </div>

    <script>
        // Global utility to show floating toasts
        function showToast(message, type = 'info') {
            const container = document.getElementById('toast-container');
            const toast = document.createElement('div');
            toast.className = `toast ${type}`;
            toast.textContent = message;
            container.appendChild(toast);

            setTimeout(() => {
                toast.remove();
            }, 5000);
        }

        // --- Chart Initialization ---
        function initCharts() {
            const ctx = document.getElementById('patientLoadChart').getContext('2d');
            const patientLoadChart = new Chart(ctx, {
                type: 'line',
                data: {
                    labels: ['Jan', 'Feb', 'Mar', 'Apr', 'May', 'Jun', 'Jul', 'Aug'],
                    datasets: [{
                        label: 'New Patients',
                        data: [15, 22, 18, 30, 25, 35, 28, 40],
                        borderColor: 'rgba(30, 136, 229, 1)',
                        backgroundColor: 'rgba(30, 136, 229, 0.1)',
                        borderWidth: 3,
                        tension: 0.4,
                        fill: true
                    },
                    {
                        label: 'Follow-ups',
                        data: [40, 35, 45, 50, 48, 55, 60, 52],
                        borderColor: 'rgba(76, 175, 80, 1)',
                        backgroundColor: 'rgba(76, 175, 80, 0.1)',
                        borderWidth: 3,
                        tension: 0.4,
                        fill: true
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: {
                            display: true,
                            position: 'top',
                        },
                        title: {
                            display: false
                        }
                    },
                    scales: {
                        y: {
                            beginAtZero: true
                        }
                    }
                }
            });
        }

        window.onload = function() {
            initCharts();
            switchSection('dashboard');
        };


        // --- Navigation and Utility Functions ---
        
        // NEW: Function to toggle sidebar visibility on mobile
        function toggleSidebar() {
            const sidebar = document.getElementById('sidebar');
            if (window.innerWidth < 768) {
                sidebar.classList.toggle('hidden');
                sidebar.classList.toggle('open');
            }
        }


        // Controls switching the main content section based on sidebar click
        function switchSection(section) {
            // 1. Hide the sidebar on mobile after selection
            if (window.innerWidth < 768) {
                const sidebar = document.getElementById('sidebar');
                if (sidebar.classList.contains('open')) {
                    sidebar.classList.remove('open');
                    sidebar.classList.add('hidden');
                }
            }
            
            // 2. Navigation logic
            document.querySelectorAll('.nav-item').forEach(item => {
                item.classList.remove('active');
                // Check if the item is an 'a' tag before checking data-section
                if (item.tagName === 'A' && item.dataset.section === section) {
                    item.classList.add('active');
                }
            });

            document.querySelectorAll('.content-section').forEach(sec => {
                sec.classList.remove('active');
            });
            
            const targetSection = document.getElementById('section-' + section);
            if (targetSection) {
                 targetSection.classList.add('active');
            } else {
                console.error(`Section not found for: ${section}`);
            }

            // 3. Update Title
            const titles = {
                'dashboard': 'Doctor Dashboard',
                'patients': 'My Patients',
                'appointments': 'Appointments Management',
                'consultations': 'Consultations History',
                'messages': 'Secure Messages',
                'analysis': 'Clinical Data Analysis', 
                'schedule': 'My Schedule',
                'settings': 'Settings'
            };
            document.getElementById('pageTitle').textContent = titles[section] || 'Dashboard';
        }

        // Handles mock logout
        function logout() {
            localStorage.clear();
            showToast('Logged out successfully!', 'success');
        }

        /**
         * Navigates to the system chooser page.
         * Since `choose-system.hyml` is likely a local file in the environment, 
         * we use window.location.href to simulate opening it.
         */
        function openSystemChooser() {
            // In a real application, you would navigate to the new HTML file.
            // Example: window.location.href = 'choose-system.hyml';
            showToast('Switching System... (Navigating to choose-system.hyml)', 'info');
            
            // For the purpose of this environment, we simulate the navigation
            // by logging a message and optionally changing content if the file existed.
            // In a live environment, the line below would execute the navigation:
            window.location.href = 'choose-system.hyml';
        }

        // --- Gemini API Implementation for Clinical Analysis ---

        /**
         * Generic fetch utility with exponential backoff for API calls.
         */
        async function fetchWithExponentialBackoff(url, options, maxRetries = 5, delay = 1000) {
            for (let i = 0; i < maxRetries; i++) {
                try {
                    const response = await fetch(url, options);
                    if (response.status === 429 && i < maxRetries - 1) {
                        const waitTime = delay * Math.pow(2, i);
                        await new Promise(resolve => setTimeout(resolve, waitTime));
                        continue; 
                    }
                    if (!response.ok) {
                        const error = await response.json();
                        throw new Error(error.error?.message || `HTTP error! status: ${response.status}`);
                    }
                    return response.json();

                } catch (error) {
                    if (i === maxRetries - 1) {
                        throw error; 
                    }
                    // Silent retry logic.
                    const waitTime = delay * Math.pow(2, i);
                    await new Promise(resolve => setTimeout(resolve, waitTime));
                }
            }
            throw new Error("API call failed after multiple retries.");
        }


        /**
         * Performs clinical data analysis using the Gemini API with Google Search grounding.
         */
        async function analyzeClinicalData() {
            const dataInput = document.getElementById('clinicalDataInput').value.trim();
            const analyzeButton = document.getElementById('analyzeButton');
            const buttonText = document.getElementById('buttonText');
            const loadingSpinner = document.getElementById('loadingSpinner');
            const outputContainer = document.getElementById('analysisOutputContainer');
            const outputDiv = document.getElementById('analysisOutput');
            const sourcesDiv = document.getElementById('citationSources');

            if (!dataInput) {
                showToast('Please paste patient data before running the analysis.', 'error');
                return;
            }

            // UI State: Loading
            analyzeButton.disabled = true;
            buttonText.textContent = 'Analyzing...';
            loadingSpinner.classList.remove('hidden');
            outputContainer.classList.add('hidden');
            outputDiv.innerHTML = '';
            sourcesDiv.innerHTML = '';
            
            const systemPrompt = "You are a specialized Clinical Data Analyst AI. Analyze the provided patient vital signs and lab data. Provide a concise clinical summary, highlight any potential health risks, and suggest further diagnostic steps. Respond professionally, focusing only on the clinical interpretation of the data.";
            
            const userQuery = `Analyze the following patient data: ${dataInput}`;
            
            const apiKey = ""; // Leave as-is for Canvas environment
            const apiUrl = `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-05-20:generateContent?key=${apiKey}`;

            const payload = {
                contents: [{ parts: [{ text: userQuery }] }],
                tools: [{ "google_search": {} }], // Enable Google Search grounding
                systemInstruction: {
                    parts: [{ text: systemPrompt }]
                },
            };

            try {
                const result = await fetchWithExponentialBackoff(apiUrl, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(payload)
                });

                const candidate = result.candidates?.[0];

                if (candidate && candidate.content?.parts?.[0]?.text) {
                    const text = candidate.content.parts[0].text;
                    let sources = [];
                    const groundingMetadata = candidate.groundingMetadata;
                    
                    if (groundingMetadata && groundingMetadata.groundingAttributions) {
                        sources = groundingMetadata.groundingAttributions
                            .map(attribution => ({
                                uri: attribution.web?.uri,
                                title: attribution.web?.title,
                            }))
                            .filter(source => source.uri && source.title);
                    }

                    // Display Analysis Result
                    // Using innerHTML to render Markdown formatting (like lists) which is common in Gemini responses
                    outputDiv.innerHTML = `<div class="markdown-body">${text.replace(/\n/g, '<br>')}</div>`;

                    // Display Sources
                    if (sources.length > 0) {
                        const uniqueSources = sources.reduce((acc, current) => {
                            const x = acc.find(item => item.uri === current.uri);
                            if (!x) {
                                return acc.concat([current]);
                            }
                            return acc;
                        }, []);

                        let sourcesHtml = '<strong>Grounding Sources:</strong><ul class="list-disc ml-5 mt-1 space-y-1">';
                        uniqueSources.forEach((source) => {
                            sourcesHtml += `<li><a href="${source.uri}" target="_blank" class="text-indigo-600 hover:text-indigo-800 underline">${source.title}</a></li>`;
                        });
                        sourcesHtml += '</ul>';
                        sourcesDiv.innerHTML = sourcesHtml;
                    } else {
                         sourcesDiv.innerHTML = '<strong>Grounding Sources:</strong> None found for this specific query.';
                    }

                    outputContainer.classList.remove('hidden');
                    showToast('Clinical analysis complete!', 'success');

                } else {
                    showToast('Analysis failed: Could not generate content.', 'error');
                }

            } catch (error) {
                console.error("Gemini API Error:", error);
                showToast(`An API error occurred: ${error.message}. Please try again.`, 'error');
            } finally {
                // UI State: Idle
                analyzeButton.disabled = false;
                buttonText.textContent = 'Run AI Analysis';
                loadingSpinner.classList.add('hidden');
            }
        }
        
    </script>
</body>
</html>
